{
  "name": "Clinic Booking System DB",
  "nodes": [
    {
      "parameters": {
        "public": true,
        "mode": "webhook",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -896,
        -416
      ],
      "id": "0795fae2-f3f0-44a5-9aa2-dd11ae4b7bfb",
      "name": "When chat message received",
      "webhookId": "a8f6d20a-bebf-47ed-85ea-7c124cc6cdec"
    },
    {
      "parameters": {},
      "id": "38da8448-39b3-403a-9a15-8248a9a1b4f2",
      "name": "Window Buffer Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.2,
      "position": [
        -576,
        -192
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "6825e62c-fc11-4a88-bcc3-03ab7973223d",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        -736,
        -192
      ],
      "credentials": {
        "openAiApi": {
          "id": "30k1hgsP9hQ1MKrP",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=Current Date & Time: {{ $now.setZone('Europe/Stockholm').format('cccc, MMMM d, yyyy, h:mm a') }}\nTime Zone: Europe/Stockholm (+01:00)\n\nYou are a smart medical receptionist for CareLine Health Clinic.\n\nYour Tools:\n- 'check_patient_status': Checks if the user is registered using their email. Returns patient_id. Always call this FIRST.\n- 'get_doctors': Use to list doctors and find their exact UUIDs.\n- 'check_availability': Use to find free slots. REQUIREMENT: You must have a 'doctor_id' AND 'date' to use this.\n- 'book_appointment': Use ONLY when the user confirms a specific time.\n- 'manage_appointments': Use to LIST existing appointments of the patient (requires patient's email).\n\n**CRITICAL CONVERSATION FLOW (Follow Strictly):**\n1.  **Identify:** Ask for the patient's **email address** immediately at the start.\n2.  **Verify:** Call 'check_patient_status' with that email.\n    * **IF \"not_registered\":** Reply EXACTLY: \"I'm sorry, but I cannot find a patient record for that email. You must register with the clinic before booking online.\" -> **THEN STOP.**\n    * **IF \"registered\":** Greet them by name. **IMMEDIATELY call 'get_doctors' and show the list of doctors.**\n3.  **Discovery:** Ask which doctor they want (Get the UUID).\n4.  **Check Date:** Ask for a date.\n    * **WEEKEND CHECK:** Always check what is the day on the given date.\n    * **If the date is Saturday or Sunday** Reply: \"The clinic is closed on weekends. Please choose a weekday (Monday-Friday).\" Do NOT call availability check.\n    * **If weekday(Monday-Friday)** Call 'check_availability' with `doctor_id` and `date`.\n5.  **Select Slot:** Present free slots.\n6.  **Notes:** Once a time is picked:\n    * Ask: \"Let me know if you have any notes to add?\"\n7.  **Confirm:** Once Notes are added:\n    Present a **Summary**: \"[Patient's Full-Name]! Your booking with Dr. [Name] on [Date] at [Time] and [Notes]\"\n    * Ask: \"Please confirm if this is correct\"\n8.  **Finalize:** When confirmed, call 'book_appointment' using the `patient_id` (from Step 1), `doctor_id`, `times`, and `notes`.\n\n**MANAGING APPOINTMENTS (View Only):**\n1. If a user wants to check their existing bookings, call `manage_appointments(patient_email=...)`.\n2. Show the list of appointments returned by the tool.\n3. If they ask to cancel or reschedule, politely inform them: \"I can only view your appointments. Please contact the clinic directly to make changes.\"\n\n**RULES:**\n- Opening Hours: Mon-Fri, 08:00-17:00.\n- Do NOT ask for Patient Name (you have it from Step 1).\n- Time Zone: Local Sweden Time."
        }
      },
      "id": "3f1752f0-0540-4560-aca2-fb0750624de1",
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -432,
        -416
      ]
    },
    {
      "parameters": {
        "name": "check_patient_status",
        "description": "Check if a user is a registered patient using their email. Always call this FIRST.",
        "workflowId": "qRA8mGMdOr2qC2lm",
        "specifyInputSchema": true,
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"email\": {\n      \"type\": \"string\",\n      \"description\": \"The patient's email address\"\n    }\n  },\n  \"required\": [\"email\"]\n}"
      },
      "id": "5afc10b3-c4cd-43e6-94fd-75f3f8c2797b",
      "name": "Check Patient Status",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.1,
      "position": [
        -416,
        -192
      ]
    },
    {
      "parameters": {
        "name": "check_availability",
        "description": "Check DATABASE availability for a specific doctor and date. Requires 'doctor_id' and 'date' (YYYY-MM-DD).",
        "workflowId": "cUUQTCoSDOnpufvd",
        "specifyInputSchema": true,
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"doctor_id\": {\n      \"type\": \"string\",\n      \"description\": \"The UUID of the doctor to check\"\n    },\n    \"date\": {\n      \"type\": \"string\",\n      \"description\": \"The date to check in YYYY-MM-DD format\"\n    }\n  },\n  \"required\": [\"doctor_id\", \"date\"]\n}"
      },
      "id": "454c8363-7bb8-4ff6-a097-6551ecb85c1d",
      "name": "Check Availability Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.1,
      "position": [
        -144,
        -192
      ]
    },
    {
      "parameters": {
        "name": "book_appointment",
        "description": "Book a confirmed slot. Requires: doctor_id, patient_id, start_time, end_time.",
        "workflowId": "wPf0Wu9H1Mq4du23",
        "specifyInputSchema": true,
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"doctor_id\": {\n      \"type\": \"string\",\n      \"description\": \"The exact UUID of the doctor (e.g. 'afc0d...'). DO NOT send '1' or '2'.\"\n    },\n    \"patient_id\": {\n      \"type\": \"string\",\n      \"description\": \"The UUID of the patient (retrieved from check_patient_status).\"\n    },\n    \"notes\": {\n      \"type\": \"string\",\n      \"description\": \"Any notes provided by the user (optional).\"\n    },\n    \"start_time\": {\n      \"type\": \"string\",\n      \"description\": \"Start time in ISO format INCLUDING the +01:00 offset for Sweden. Example: 2025-12-10T09:00:00+01:00\"\n    },\n    \"end_time\": {\n      \"type\": \"string\",\n      \"description\": \"End time in ISO format INCLUDING the +01:00 offset for Sweden. Example: 2025-12-10T09:30:00+01:00\"\n    }\n  },\n  \"required\": [\n    \"doctor_id\",\n    \"patient_id\",\n    \"start_time\",\n    \"end_time\"\n  ]\n}"
      },
      "id": "9297ee0a-d5b8-47e8-8ae9-0659d5f3f902",
      "name": "Book Appointment Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.1,
      "position": [
        16,
        -192
      ]
    },
    {
      "parameters": {
        "description": "Call this tool to get the list of all doctors and their specializations from the database.",
        "jsCode": "const supabaseUrl = 'https://norddgwsmfrnztzluewn.supabase.co';\nconst supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vcmRkZ3dzbWZybnp0emx1ZXduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MDE1NDEsImV4cCI6MjA4MDM3NzU0MX0.p9dphFXe0COG0ztfvHdHBfJFJuMaAoJoLskGltSdh-8';\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${supabaseUrl}/rest/v1/doctors?select=*`,\n    headers: {\n      'apikey': supabaseKey,\n      'Authorization': `Bearer ${supabaseKey}`\n    }\n  });\n  return JSON.stringify(response);\n} catch (error) {\n  return \"Error fetching doctors: \" + error.message;\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        -272,
        -192
      ],
      "id": "9138c640-5baf-40a8-9984-f14d80218c43",
      "name": "get_doctors"
    },
    {
      "parameters": {
        "name": "manage_appointments",
        "description": "Lists active confirmed appointments for a patient. Requires 'patient_email'.",
        "workflowId": "UPmSQQoPYHBySpdo",
        "specifyInputSchema": true,
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"patient_email\": {\n      \"type\": \"string\",\n      \"description\": \"The patient's email address to look up.\"\n    }\n  },\n  \"required\": [\"patient_email\"]\n}"
      },
      "id": "d12b3a56-59a4-4c9a-8145-c0cd1840cc9c",
      "name": "Manage Appointments Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.1,
      "position": [
        160,
        -192
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "When chat message received": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Check Availability Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Book Appointment Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Check Patient Status": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "get_doctors": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Manage Appointments Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "versionId": "5710deb9-3308-41dd-ba2f-3f7822cbb958",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "276cbe01a6dd2f4f2e75ce692db9264ce544694cc874c72a2291a3ddd20bb787"
  },
  "id": "yH8CqGsUWNjgmng6",
  "tags": []
}